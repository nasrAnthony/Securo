{% extends "base.html" %}
{% load static %}
{% block title %}Request a Quote - Securo{% endblock %}

{% block content %}
<section class="quote-hero animate-on-scroll from-right">
  <div class="quote-container">
    <h1 class="quote-slogan">Get Your <span class="highlight-you">Quote</span></h1>

    <form class="quote-form" method="post"
      data-has-open="{{ has_open|yesno:'true,false' }}">
      {% csrf_token %}
      <div class="form-grid">

        <!-- Full Name -->
        <div class="form-group">
          {{ form.full_name.label_tag }}
          {{ form.full_name }}
          {{ form.full_name.errors }}
        </div>

        <div class="form-group">
          {{ form.business_name.label_tag }}
          {{ form.business_name }}
          {{ form.business_name.errors }}
        </div>

        <!-- Email -->
        <div class="form-group">
          {{ form.email.label_tag }}
          {{ form.email }}
          {{ form.email.errors }}
        </div>

        <!-- Phone -->
        <div class="form-group">
          {{ form.phone_number.label_tag }}
          {{ form.phone_number }}
          {{ form.phone_number.errors }}
        </div>

        <!-- Project Details -->
        <div class="form-group form-full">
          {{ form.project_details.label_tag }}
          {{ form.project_details }}
          {{ form.project_details.errors }}
        </div>

        <!-- Address -->
        <div class="form-group">
          {{ form.address.label_tag }}
          {{ form.address }}
          {{ form.address.errors }}
        </div>

        <!-- Unit -->
        <div class="form-group">
          {{ form.unit.label_tag }}
          {{ form.unit }}
          {{ form.unit.errors }}
        </div>

        <!-- City -->
        <div class="form-group">
          {{ form.city.label_tag }}
          {{ form.city }}
          {{ form.city.errors }}
        </div>

        <!-- Province -->
        <div class="form-group">
          {{ form.province.label_tag }}
          {{ form.province }}
          {{ form.province.errors }}
        </div>

        <!-- Postal Code -->
        <div class="form-group">
          {{ form.postal_code.label_tag }}
          {{ form.postal_code }}
          {{ form.postal_code.errors }}
        </div>

        <!-- Property Type (radio group) -->
        <div class="form-group form-full">
          {{ form.property_type.label_tag }}
          <div class="radio-group">
            {{ form.property_type }}
          </div>
          {{ form.property_type.errors }}
        </div>

        <!-- Consultation Date -->
        <div class="form-group">
          <label for="consultation_date" class="required-label">
            Preferred Consultation Date
            <span class="tooltip-icon" tabindex="0">?
              <span class="tooltip-text">Pick a date that works best for an in-person or virtual consultation.</span>
            </span>
          </label>
          {{ form.preferred_date }}
          {{ form.preferred_date.errors }}
        </div>

        <!-- Consultation Time -->
        <div class="form-group">
          {{ form.preferred_time.label_tag }}
          {{ form.preferred_time }}
          {{ form.preferred_time.errors }}
        </div>

        <!-- Submit -->
        <div class="form-group form-full">
          <button type="submit" class="cta-button">Request a Quote</button>
        </div>

      </div>
    </form>
  </div>

  {% if request.user.is_authenticated %}
  <!-- Open-Quote Warning Modal -->
  <div class="modal" id="open-quote-warning" aria-hidden="true" role="dialog" aria-modal="true"
      aria-labelledby="open-quote-warning-title">
    <div class="modal__overlay" data-close></div>

    <div class="modal__content" role="document">
      <div class="modal__icon" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="10" stroke="#b45309" stroke-width="2"/>
          <path d="M12 7v6m0 4h.01" stroke="#b45309" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>

      <h3 id="open-quote-warning-title">You already have an open quote</h3>
      <p class="modal__text">
        We found {{ open_count }} open request{{ open_count|pluralize }} on your account.
        Are you sure you want to submit another?
      </p>

      <div class="modal__actions">
        <button type="button" class="btn btn-outline" data-close>Keep editing</button>
        <button type="button" class="btn btn-primary" id="confirm-submit-quote">Submit anyway</button>
      </div>
    </div>
  </div>
  {% endif %}
</section>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
      document.querySelectorAll('.animate-on-load').forEach(el => {
        el.classList.add('visible');
      });
    }, 100);
  });

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, {
    threshold: 0.1
  });

  document.querySelectorAll('.animate-on-scroll').forEach(el => {
    observer.observe(el);
  });

  // Set minimum date to today for consultation date
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById("id_preferred_date");
  if (dateInput) {
    dateInput.setAttribute("min", today);
  }
</script>

<script>
(function () {
  const form = document.querySelector('.quote-form');
  if (!form) return;

  // Read server-provided flag from the data attribute; default to false.
  const hasOpen = (form.dataset.hasOpen === 'true');

  const modal = document.getElementById('open-quote-warning');
  const confirmBtn = document.getElementById('confirm-submit-quote');

  function openModal() {
    if (!modal) return;
    modal.classList.add('is-open');
    document.body.style.overflow = 'hidden';
    if (confirmBtn) confirmBtn.focus();
  }
  function closeModal() {
    if (!modal) return;
    modal.classList.remove('is-open');
    document.body.style.overflow = '';
  }

  if (modal) {
    modal.addEventListener('click', function (e) {
      if (e.target.classList && e.target.classList.contains('modal__overlay')) {
        closeModal();
      }
    });
    var closers = modal.querySelectorAll('[data-close]');
    for (var i = 0; i < closers.length; i++) closers[i].addEventListener('click', closeModal);
    window.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && modal.classList.contains('is-open')) closeModal();
    });
  }

  var bypass = false;
  form.addEventListener('submit', function (e) {
    if (!bypass && hasOpen) {
      e.preventDefault();
      openModal();
    }
  });

  if (confirmBtn) {
    confirmBtn.addEventListener('click', function () {
      bypass = true;
      closeModal();
      form.submit();
    });
  }
})();
</script>


{% endblock %}
